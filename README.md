# EBHMM

EBHMM is a software for detecting copy number alterations (CNAs) from tumor sequencing data. It first extracts allele depth and read counts data 
from tumor sequencing data, then detects CNAs by leveraging a novel hidden Markov model.

## Requirements

* Linux systems.
* CMake3.0+.
* g++.

## Installation

To build binary, do as follows:

```
tar -zxvf EBHMM.tar.gz
cd EBHMM
cmake .
make
make install
```

## Usage

### Step 1: prepare input data for calling CNAs

The “ebhmm prepareinputs” command is used to obtain allele depth, read counts, GC-content and mappability data. 

To successfully run the command you will need to obtain/create these items:
* A BAM file containing tumor sequencing data
* A FASTA file defining reference sequence
* A BIGWIG file for calculating mappability scores 
* A SNP file containing location information of known SNPs

Reference sequence file formatted as .fasta can be downloaded from [UCSC genome browser](http://hgdownload.soe.ucsc.edu/downloads.html).

Mappability files formatted as .bw for human genomes are available from [UCSC genome browser](http://hgdownload.soe.ucsc.edu/downloads.html). 
Users can also generate their own mappability files using [gem-library](https://sourceforge.net/projects/gemlibrary/files/gem-library/Binary%20pre-release%203/) and [wigToBigWig](http://hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/) utility.

Here is an example for creating mappability file from reference sequence 
(suppose “$gemlibrary” and “$bigwig” are the pathes where gem-library and wigToBigWig are installed, respectively).
```
chmod +x $gemlibrary/bin/gem* $bigwig/wigToBigWig
export PATH=$PATH:$gemlibrary/bin:$bigwig
gem-indexer -T 10 -c dna -i ./testData/refs/example.fa -o ./testData/refs/example_index
gem-mappability -T 10 -I ./testData/refs/example_index.gem -l 36 -o ./testData/refs/example_36
gem-2-wig -I ./testData/refs/example_index.gem -i ./testData/refs/example_36.mappability -o ./testData/refs/example_36
wigToBigWig ./testData/refs/example_36.wig ./testData/refs/example.sizes ./testData/refs/example_36.bw
```

For human genomes, we provide SNP files in the [snp](testData/snps/) subdirectory of the EBHMM software package. 
For other genomes, users can download the SNP data from [UCSC genome browser](https://genome.ucsc.edu/cgi-bin/hgTables). The following filtering rules should be used:  
`#filter: valid != 'unknown' and molType = 'genomic' and class = 'single' and locType = 'exact'`

The downloaded SNP data should be further processed to only remain “chrom” and “chromEnd” fields.

The all arguments of the “EBHMM prepareinputs” command are as follows:

Parameter | Description | Possible values
---- | ----- | ------
-b, --bam | sequencing data (.bam) | Ex: /path/to/sample.bam  
-r, --ref | genome reference file (.fasta) | Ex: /path/to/hg19.fa
-m, --map | mappability file (.bw) | Ex: /path/to/hg19.bw
-s, --snp | SNP file | Ex: /path/to/hg19_snp138_chr_pos.txt
-M, --male | indicate sample from a male | 
-w, --window | the size of windows to count reads | Ex: window=50000  default:10000
-Q, --baseQ | threshold value for base quality | Ex: baseQ=15  default:10
-q, --mapQ | threshold value for mapping quality | Ex: mapQ=10  default:20
-d, --minDepth | minimum read depth for filtering SNP positions | Ex: minDepth=10  default:5
-o, --output | output file to save results | Ex: /path/to/results.txt

Example:
```
ebhmm prepareinputs -b example.bam -r hg19.fasta -m hg19.bw -s hg19.snp151.chr.pos.txt -M -w 50000 -o example.txt
```

### Step 2: detect and visualize CNAs

The “ebhmm callcnas” command is designed to call and visualize CNAs. 
If MATLAB Compiler Runtime (MCR) is installed in user's machine, EBHMM will plot segmentation results of each chromosome. 
The MCR can be downloaded from [MathWorks Web site](https://www.mathworks.com/products/compiler/matlab-runtime.html). 

The arguments of the command are as follows:

Parameter | Description | Possible values
---- | ----- | ------
-i, --input | input file generated by “prepareinputs” subcommand | Ex: /path/to/example.txt
-d, --minDepth | filter out positions with read depth less than this value | Ex: minDepth=15  default:5
-D, --maxDepth | filter out positions with read depth larger than this value | Ex: maxDepth=200  default:300
-C, --maxCN | maximum copy number to be considered in HMM | Ex: maxCN=5  default:7
-p, --ploidy | ploidy of the sample, should be a value in (2, 3, 4) | Ex: ploidy=2  default:to be inferred from the data
-t, --threads | number of threads to use | Ex: threads=5  default:1
-o, --output | output directory to save results | Ex: /path/to/results

Example:

```
gzip -cd ./testData/exampleInputs/example.txt.gz > ./testData/exampleInputs/example.txt
mkdir results
ebhmm callcnas -i ./testData/exampleInputs/example.txt -d 5 -p 2 -t 5 -o ./results
```

## Contact

If you have any questions, please contact zhyu@nxu.edu.cn.